{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% if initial_route == "branddozer_solo" %}BrandDozer{% else %}R3V3N!R Control Tower{% endif %}</title>
    <link rel="icon" href="{% static 'assets/logo.png' %}" />
    {% if serve_vite %}
      <script type="module">
        const DEV_ORIGIN = "{{ vite_dev_server }}";
        const FALLBACK = "{% static 'assets/main.js' %}?v={{ asset_version }}";
        (async () => {
          try {
            await import(`${DEV_ORIGIN}/@vite/client`);
            await import(`${DEV_ORIGIN}/src/main.ts`);
          } catch (error) {
            console.warn("Vite dev server unavailable; falling back to bundled assets.", error);
            await import(FALLBACK);
          }
        })();
      </script>
    {% else %}
      <script type="module" src="{% static 'assets/main.js' %}?v={{ asset_version }}"></script>
    {% endif %}
    <link rel="stylesheet" href="{% static 'assets/main.css' %}?v={{ asset_version }}" />
    <style>
      :root {
        color-scheme: dark;
        --accent-1: #060a11;
        --accent-2: #0d1a2b;
        --accent-3: #b6ccff;
        --accent-ok: #34d399;
        --accent-warn: #f6b143;
        --accent-err: #ff5a5f;
        --bg: radial-gradient(circle at 16% 16%, rgba(12, 18, 32, 0.95), rgba(3, 5, 10, 0.98));
        --panel-bg: rgba(5, 9, 16, 0.9);
        --panel-border: rgba(165, 194, 255, 0.22);
        font-family: "Hackout", "Segoe UI", "Helvetica", sans-serif;
        --font-title: "EscapeArtist", "Hackout", "Segoe UI", sans-serif;
        --font-body: "Hackout", "Segoe UI", "Helvetica", sans-serif;
      }
      * {
        box-sizing: border-box;
        border-radius: 0 !important;
      }
      body {
        margin: 0;
        background: var(--bg), #050505;
        color: #f2f2f4;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
        position: relative;
      }
      #matrix-bg {
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        pointer-events: none;
        opacity: 0.95;
        mix-blend-mode: screen;
      }
      .splash-overlay {
        position: fixed;
        inset: 0;
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(2, 6, 12, 0.92);
        opacity: 1;
        transition: opacity 0.5s ease;
      }
      .splash-overlay.fade-out {
        opacity: 0;
      }
      .splash-logo {
        width: min(280px, 70vw);
        height: auto;
        filter: drop-shadow(0 12px 28px rgba(59, 130, 246, 0.25));
      }
      header.site-header,
      main.app-shell,
      footer.site-footer {
        position: relative;
        z-index: 1;
      }
      header.site-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem 1.75rem;
        gap: 1.5rem;
        background: linear-gradient(135deg, rgba(28, 32, 44, 0.92), rgba(9, 12, 18, 0.9));
        box-shadow: 0 10px 32px rgba(0, 0, 0, 0.38);
        position: sticky;
        top: 0;
        z-index: 100;
      }
      header.site-header .brand {
        display: flex;
        align-items: center;
        gap: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.22rem;
      }
      header.site-header img {
        height: 60px;
      }
      header.site-header h1 {
        margin: 0;
        font-size: 1.4rem;
        color: var(--accent-3);
      }
      header.site-header .user-chip {
        font-size: 0.85rem;
        opacity: 0.75;
      }
      header.site-header .user-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .logout-btn {
        background: rgba(111, 167, 255, 0.18);
        border: 1px solid rgba(111, 167, 255, 0.35);
        color: #e2e8f0;
        padding: 0.4rem 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.14rem;
        font-size: 0.7rem;
        cursor: pointer;
      }
      main.app-shell {
        flex: 1;
        display: flex;
        position: relative;
      }
      .login-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 4rem 1.5rem;
      }
      .login-card {
        width: min(420px, 100%);
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        padding: 2.2rem 2rem;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.45);
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      .login-card h2 {
        margin: 0;
        font-size: 1.35rem;
        text-transform: uppercase;
        letter-spacing: 0.2rem;
        color: var(--accent-3);
      }
      .login-card label {
        font-size: 0.85rem;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        letter-spacing: 0.08rem;
        text-transform: uppercase;
      }
      .login-card input {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(111, 167, 255, 0.25);
        font-size: 1rem;
        padding: 0.75rem;
        color: #f5f8ff;
      }
      .login-card button {
        margin-top: 0.5rem;
        padding: 0.85rem;
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.16rem;
        border: none;
        background: linear-gradient(135deg, var(--accent-2), var(--accent-3));
        color: #0b141f;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .login-card button:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 30px rgba(111, 167, 255, 0.35);
      }
      .auth-actions {
        display: flex;
        justify-content: center;
      }
      .secondary-link {
        color: rgba(127, 176, 255, 0.85);
        text-transform: uppercase;
        letter-spacing: 0.12rem;
        font-size: 0.75rem;
      }
      .login-card .form-errors {
        color: var(--accent-err);
        font-size: 0.85rem;
      }
      .fallback-grid {
        padding: 2.5rem 3rem;
        width: 100%;
        display: grid;
        grid-template-columns: 260px 1fr;
        gap: 1.5rem;
      }
      .fallback-panel {
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        padding: 1.25rem;
        box-shadow: 0 16px 32px rgba(0, 0, 0, 0.42);
      }
      .fallback-panel h3 {
        margin: 0 0 1rem;
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.12rem;
        color: var(--accent-3);
      }
      .fallback-panel table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.92rem;
      }
      .fallback-panel th,
      .fallback-panel td {
        padding: 0.4rem 0.6rem;
        border-bottom: 1px solid rgba(111, 167, 255, 0.18);
        text-align: left;
      }
      .fallback-panel tbody tr:last-child td {
        border-bottom: none;
      }
      footer.site-footer {
        text-align: center;
        padding: 1rem;
        font-size: 0.78rem;
        color: rgba(255, 255, 255, 0.45);
      }
    </style>
  </head>
  <body>
    <canvas id="matrix-bg" aria-hidden="true"></canvas>
    <div class="splash-overlay" id="splash-overlay">
      <img class="splash-logo" src="{% static 'assets/main_logo.png' %}" alt="R3V3N!R logo" />
    </div>
    {% if initial_route != "branddozer_solo" %}
      <header class="site-header">
        <div class="brand">
          <img src="{% static 'assets/main_logo.png' %}" alt="R3V3N!R insignia" />
          <h1>R3V3N!R • Crypto Trading AI Bot</h1>
        </div>
        {% if user.is_authenticated %}
          <div class="user-actions">
            <span class="user-chip">Logged in as {{ user.get_username }}</span>
            <form method="post" action="{% url 'core:logout' %}">
              {% csrf_token %}
              <button type="submit" class="logout-btn">Log out</button>
            </form>
          </div>
        {% endif %}
      </header>
    {% endif %}
    {% if user.is_authenticated %}
      <main class="app-shell">
        <noscript>
          <div class="fallback-grid">
            <aside class="fallback-panel">
              <h3>Snapshot</h3>
              <p>Stable bank: {{ fallback_snapshot.stable_bank|floatformat:2 }}</p>
              <p>Total profit: {{ fallback_snapshot.total_profit|floatformat:2 }}</p>
              <p>Open advisories: {{ fallback_snapshot.advisories|length }}</p>
            </aside>
            <section class="fallback-panel">
              <h3>Latest Metrics</h3>
              <table>
                <tbody>
                  {% for metric in fallback_snapshot.latest_metrics %}
                    <tr>
                      <td>{{ metric.stage }}</td>
                      <td>{{ metric.name }}</td>
                      <td>{{ metric.value|floatformat:3 }}</td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="3">No metrics recorded.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </section>
          </div>
        </noscript>
        <div
          id="app"
          data-initial-route="{{ initial_route }}"
          data-initial-path="{{ request.path }}"
          data-fallback-id="fallback-data"
        ></div>
        {{ fallback_snapshot|json_script:"fallback-data" }}
      </main>
    {% else %}
      <main class="app-shell">
        <section class="login-wrapper">
          {% if auth_mode == "signup" %}
            <form method="post" class="login-card">
              <h2>Create Account</h2>
              {% csrf_token %}
              {% if signup_form.non_field_errors %}
                <div class="form-errors">
                  {{ signup_form.non_field_errors }}
                </div>
              {% endif %}
              <label>
                Username
                {{ signup_form.username }}
              </label>
              <label>
                Password
                {{ signup_form.password1 }}
              </label>
              <label>
                Confirm Password
                {{ signup_form.password2 }}
              </label>
              <button type="submit">Create User</button>
              <div class="auth-actions">
                <a class="secondary-link" href="{% url 'core:index' %}">Back to login</a>
              </div>
            </form>
          {% else %}
            <form method="post" class="login-card">
              <h2>Authenticate</h2>
              {% csrf_token %}
              {% if auth_form.non_field_errors %}
                <div class="form-errors">
                  {{ auth_form.non_field_errors }}
                </div>
              {% endif %}
              <label>
                Username
                {{ auth_form.username }}
              </label>
              <label>
                Password
                {{ auth_form.password }}
              </label>
              <button type="submit">Access R3V3N!R</button>
              <div class="auth-actions">
                <a class="secondary-link" href="{% url 'core:signup' %}">Create a new user</a>
              </div>
            </form>
          {% endif %}
        </section>
      </main>
    {% endif %}
    {% if initial_route != "branddozer_solo" %}
      <footer class="site-footer">© {% now "Y" %} R3V3N!R • Autonomous Trading Control Tower</footer>
    {% endif %}
    <script>
      (() => {
        const splash = document.getElementById('splash-overlay');
        if (splash) {
          requestAnimationFrame(() => {
            setTimeout(() => {
              splash.classList.add('fade-out');
            }, 50);
          });
          splash.addEventListener('transitionend', () => {
            splash.remove();
          });
        }
      })();
    </script>
    <script>
      (() => {
        const canvas = document.getElementById('matrix-bg');
        if (!canvas || !canvas.getContext) return;
        const ctx = canvas.getContext('2d');
        if (!ctx) return;
        const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        let width = 0;
        let height = 0;
        let dpr = Math.min(window.devicePixelRatio || 1, 2);
        let nodes = [];
        let stars = [];
        let backgroundGradient = null;
        const mouse = { x: null, y: null };

        const initNodes = () => {
          const count = Math.min(140, Math.max(60, Math.floor((width * height) / 18000)));
          nodes = Array.from({ length: count }).map(() => ({
            x: Math.random() * width,
            y: Math.random() * height,
            vx: (Math.random() - 0.5) * 0.35,
            vy: (Math.random() - 0.5) * 0.35,
            radius: 1.2 + Math.random() * 1.6,
          }));
        };

        const initStars = () => {
          const count = Math.min(120, Math.max(60, Math.floor((width * height) / 18000)));
          stars = Array.from({ length: count }).map(() => ({
            x: Math.random() * width,
            y: Math.random() * height,
            r: 0.6 + Math.random() * 1.4,
            a: 0.25 + Math.random() * 0.6,
            tw: 0.003 + Math.random() * 0.008,
            vy: 0.05 + Math.random() * 0.18,
            vx: (Math.random() - 0.5) * 0.04,
          }));
        };

        const buildGradient = () => {
          const radius = Math.max(width, height) * 0.9;
          const gradient = ctx.createRadialGradient(width * 0.2, height * 0.15, 0, width * 0.4, height * 0.3, radius);
          gradient.addColorStop(0, 'rgba(10, 16, 30, 0.9)');
          gradient.addColorStop(0.4, 'rgba(18, 20, 38, 0.78)');
          gradient.addColorStop(0.7, 'rgba(20, 10, 32, 0.7)');
          gradient.addColorStop(1, 'rgba(2, 4, 8, 0.95)');
          backgroundGradient = gradient;
        };

        const resize = () => {
          width = window.innerWidth;
          height = window.innerHeight;
          dpr = Math.min(window.devicePixelRatio || 1, 2);
          canvas.width = width * dpr;
          canvas.height = height * dpr;
          canvas.style.width = `${width}px`;
          canvas.style.height = `${height}px`;
          ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
          buildGradient();
          initNodes();
          initStars();
        };

        const step = () => {
          ctx.clearRect(0, 0, width, height);
          ctx.fillStyle = backgroundGradient || 'rgba(4, 8, 16, 0.6)';
          ctx.fillRect(0, 0, width, height);

          for (const star of stars) {
            star.a += (Math.random() - 0.5) * star.tw;
            const alpha = Math.max(0.15, Math.min(0.85, star.a));
            ctx.fillStyle = `rgba(220, 230, 255, ${alpha})`;
            ctx.beginPath();
            ctx.arc(star.x, star.y, star.r, 0, Math.PI * 2);
            ctx.fill();
            star.y += star.vy;
            star.x += star.vx;
            if (star.y > height + 10) {
              star.y = -10;
              star.x = Math.random() * width;
            }
            if (star.x < -10) star.x = width + 10;
            if (star.x > width + 10) star.x = -10;
          }

          const connectDist = Math.max(120, Math.min(180, Math.min(width, height) * 0.18));
          const influence = 160;

          for (const node of nodes) {
            if (mouse.x !== null && mouse.y !== null) {
              const dx = node.x - mouse.x;
              const dy = node.y - mouse.y;
              const dist = Math.hypot(dx, dy);
              if (dist < influence && dist > 0.1) {
                const force = (1 - dist / influence) * 0.08;
                node.vx += (dx / dist) * force;
                node.vy += (dy / dist) * force;
              }
            }

            node.x += node.vx;
            node.y += node.vy;

            if (node.x < -20) node.x = width + 20;
            if (node.x > width + 20) node.x = -20;
            if (node.y < -20) node.y = height + 20;
            if (node.y > height + 20) node.y = -20;
          }

          for (let i = 0; i < nodes.length; i++) {
            for (let j = i + 1; j < nodes.length; j++) {
              const a = nodes[i];
              const b = nodes[j];
              const dx = a.x - b.x;
              const dy = a.y - b.y;
              const dist = Math.hypot(dx, dy);
              if (dist < connectDist) {
                const alpha = 1 - dist / connectDist;
                ctx.strokeStyle = `rgba(200, 215, 235, ${0.28 * alpha})`;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(a.x, a.y);
                ctx.lineTo(b.x, b.y);
                ctx.stroke();
              }
            }
          }

          for (const node of nodes) {
            ctx.fillStyle = 'rgba(175, 195, 215, 0.82)';
            ctx.beginPath();
            ctx.arc(node.x, node.y, node.radius, 0, Math.PI * 2);
            ctx.fill();
          }

          if (!prefersReduced) {
            requestAnimationFrame(step);
          }
        };

        window.addEventListener('mousemove', (event) => {
          mouse.x = event.clientX;
          mouse.y = event.clientY;
        });
        window.addEventListener('mouseleave', () => {
          mouse.x = null;
          mouse.y = null;
        });
        window.addEventListener('resize', resize);

        resize();
        step();
      })();
    </script>
  </body>
</html>
